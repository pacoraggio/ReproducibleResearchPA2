---
title: "Data Processing notes"
author: "Paolo Coraggio"
date: "09/01/2020"
output: html_document
---

```{r setup, include=FALSE}
library(lubridate)
library(ggplot2)
library(dplyr)

knitr::opts_chunk$set(echo = TRUE)
```

## Data Processing

The raw data file is more than 500Mb and so it would be beneficial if we could load only the information we consider necessary for answering the the proposed questions.

Extracting the first lines from the .csv file gives us information about the variable it contains

```{r varnames}
names <- read.csv("./data/repdata_data_StormData.csv/repdata_data_StormData.csv", 
                  nrows = 10, header = TRUE)

knitr::kable(names[1:3,])
```

The database contains $37$ variables, in order to address the questions, the following 12 variables are extracted from the .csv file (all rows included)

- "STATE__"    
- "BGN_DATE"   
- "STATE"      
- "EVTYPE"     
- "F"          
- "MAG"       
- "FATALITIES" 
- "INJURIES"   
- "PROPDMG"    
- "PROPDMGEXP" 
- "CROPDMG"    
- "CROPDMGEXP"

With `F` and `MAG` variably possibly redundant. 

```{r loadingraw}
df.rawdata <- read.csv("./data/repdata_data_StormData.csv.bz2",
                    colClasses = c("character", 
                                   "character", 
                                   rep("NULL",4), 
                                   rep("character",2),
                                   rep("NULL",12),
                                   "character","numeric",
                                   rep("numeric",3),
                                   "character", 
                                   "numeric", 
                                   "character", 
                                   rep("NULL",9)))

knitr::kable(head(df.rawdata))
```

After loading the raw data, the database is further reducing by considering raws where at least one fatality/injury/property or crop damage have been recorder.

```{r reducedraw}
df.rawdatared <- df.rawdata[!(df.rawdata$FATALITIES == 0 &
                              df.rawdata$INJURIES == 0 &
                              df.rawdata$PROPDMG == 0 &
                              df.rawdata$CROPDMG == 0),]

## convert Begin Date to Date format
df.rawdatared$BGN_DATE <- as.Date(sub(" .*", "", df.rawdatared$BGN_DATE), format("%m/%d/%Y"))
```

In this way the original database consisting of $902297 \times 37$ values has been pruned into a more handable $254633 \times 12$ values database.

### Selecting and merging Event Type

The [National Weather Service Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) document lists $48$ different event type (ref. section 2.1.1 for the Storm Data Event Table and Chapter 7 for event type description) while `EVTYPE` database variable contains `r length(unique(df.rawdatared$EVTYPE))` different values.  